#!/bin/bash

if [ "$1" = "" ] ; then
	FOLDER=$( mktemp )	; echo . > $FOLDER
	MENU=$( mktemp )
	FILES=$( mktemp )
	_PWD_=$( pwd )
	find . -type f -name '*.html' -not -name 'template.html' | sort > $FILES

	echo "				<p>" >> $MENU
	BLOCKS="medlemskab om";
	for FILE in ./index.html							; do	$_PWD_/$0 menu  $MENU $FILE $FOLDER ; done
	for BLOCK in $BLOCKS ; do for FILE in \
		$( sort < $FILES | grep "^./$BLOCK/$BLOCK.html" )			\
		$( sort < $FILES | grep "^./$BLOCK/" | grep -v "^./$BLOCK/$BLOCK.html" ) ; do	$_PWD_/$0 menu	$MENU $FILE $FOLDER ; done ; done
	for FILE in \
		$( sort < $FILES | grep -v "^./index.html" | grep -v "^./medlemskab/" | grep -v "^./om/" ) ; do
												$_PWD_/$0 menu	$MENU $FILE $FOLDER ; done
	echo "				</p>" >> $MENU

	for FILE in $( cat $FILES ) ; do
		$_PWD_/$0 build	$MENU $FILE
	done
	rm $FOLDER $MENU $FILES
elif [ "$1" = "menu" ] ; then
	FOLDER=$4
	TARGET=$( echo $3 | sed "s/^.//" )
	TEXT=$( cat $3 | sed ':a;N;$!ba;s/.*<section>//'| grep "<h1>" -i | sed "s/.*<h1>\(.*\)<\/h1>.*/\\1/g" )
	[ "$TEXT" = "" ] && TEXT=$( basename $3 )
	(
		echo -n	"					"
		if [ "$FOLDER" != "." ] ; then
			echo -n "&nbsp;&nbsp;"
			cat $FOLDER
		fi
		echo "<a href='$TARGET'>$TEXT</a></br>"
	) >> $2
	dirname $3 > $FOLDER
elif [ "$1" = "build" ]  && [ -f "$3" ] ; then
	MENU=$2
	TARGET=$3
	echo $TARGET
	mkdir $( dirname $TARGET ) -pv
	if false ; then
		echo "######################################################################"
		echo "######################################################################"
		echo "######################################################################"
		echo "#####"
		echo "##### $3"
		echo "#####"
		echo "######################################################################"
		cat $3 | sed ":a;N;$!ba;s/\<[^\>]*>//g" | aspell -a
		echo "######################################################################"
	fi
	CONTENT=$( mktemp )
	cat $TARGET | sed ':a;N;$!ba;s/.*<section>//' | sed ':a;N;$!ba;s/<\/section>.*//' > $CONTENT
	(
		cat template.html | sed ':a;N;$!ba;s/!!!!!!! MENU !!!!!!!.*//'
		cat $MENU
		cat template.html | sed ':a;N;$!ba;s/.*!!!!!!! MENU !!!!!!!//'	| sed ':a;N;$!ba;s/<section>.*/<section>/'
		cat $CONTENT
		cat template.html						| sed ':a;N;$!ba;s/.*<\/section>[\r\n]*/<\/section>/'
	) > $TARGET
	rm $CONTENT
fi
