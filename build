#!/bin/bash

if [ "$1" = "" ] ; then
	MENU=$( mktemp )
	_PWD_=$( pwd )
	cd ../alslug.dk-content &&
	echo "<ol>" >> $MENU
	find . -type f -name '*.html' -not -name 'template.html' -exec $_PWD_/$0 menu	$MENU \{\} \;
	echo "</ol>" >> $MENU
	find . -type f -name '*.html' -not -name 'template.html' -exec $_PWD_/$0 build	$MENU \{\} \;
	rm $MENU
elif [ "$1" = "menu" ] ; then
	TARGET=$( echo $3 | sed "s/^.//" )
	echo "<li><a href='$TARGET'>$TARGET</a></li>" >> $2
elif [ "$1" = "build" ]  && [ -f "$3" ] ; then
	MENU=$2
	TARGET=../alslug.github.io/$3
	echo $TARGET
	mkdir $( dirname $TARGET ) -pv
	(
		cat template.html | sed ':a;N;$!ba;s/!!!!!!! MENU !!!!!!!.*//'

		cat $MENU

		cat template.html | sed ':a;N;$!ba;s/.*!!!!!!! MENU !!!!!!!//'	| sed ':a;N;$!ba;s/<section>.*/<section>/'

		cat $3					|
		sed 's/^$/<br>/'			|
		sed 's/####\(.*\)####/<h4>\1<\/h4>/g'	|
		sed 's/###\(.*\)###/<h3>\1<\/h3>/g'	|
		sed 's/##\(.*\)##/<h2>\1<\/h2>/g'	|
		sed 's/#\(.*\)#/<h1>\1<\/h1>/g'

		cat template.html							| sed ':a;N;$!ba;s/.*<\/section>/<\/section>/'	|
			sed "s/!!!!!UPDATED!!!!!/$( date --reference=$3 )/"
	) > $TARGET
fi
